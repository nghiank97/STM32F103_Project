#include "pid.h"

PIDController::PIDController(float P, float I , float D, uint16_t limit,float ts)
    : P(P)
    , I(I)
	, D(D)
    , limit(limit)
	, ts(ts)
{
	proportional = 0;
	integral = 0;
	derivative = 0;
	output = 0;
	error_prev = 0;
	integral_prev = 0;
}

float PIDController::operator() (float error){
	proportional = P * error;
	integral = integral_prev + I*(float)ts*error;

	if (integral < -limit/2){
		integral = -limit/2;
	}
	if (integral < -limit/2){
		integral = -limit/2;
	}
	integral = _constrain(integral, -limit/2, limit/2);

	derivative = D*(error - error_prev)/ts;
	output= proportional + integral + derivative;

    output = _constrain(output, -limit, limit);

    integral_prev = integral;
    error_prev = error;
    return output;
}

void PIDController::setLimit(uint16_t l){
	limit = l;
}
