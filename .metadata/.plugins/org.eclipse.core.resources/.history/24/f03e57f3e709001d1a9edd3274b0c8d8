
#include <math.h>
#include <stdio.h>
#include "main.h"
#include "EncoderSPI.h"
#include "base/foc_utils.h"
EncoderSPI::EncoderSPI(void){
#ifndef ENCODER_CPR
#error "don't define encoder cpr"
#endif
}
void EncoderSPI::init(){
    getOffset();
	raw_encoder = encoder_spi_read();
	pre_raw_encoder = raw_encoder;
}
void EncoderSPI::update() {
    uint16_t val = encoder_spi_read();
    int16_t d_angle = val - raw_encoder;
    if(abs(d_angle) > (_80_PRECENT_ENC)) full_rotations += ( d_angle > 0 ) ? -1 : 1;
    raw_encoder = val;
}
float EncoderSPI::getRadiantAngle(void){
	return raw_encoder*ENC_2_ANGLE;
}
void EncoderSPI::getOffset(void){
	uint32_t offset = 0;
	for(int i=0;i<100;i++){
		offset += encoder_spi_read();
		HAL_Delay(1);
	}
	offset_raw_encoder = offset/100;
}
float EncoderSPI::getVelocity(void) {
	float delta_encoder = (raw_encoder - pre_raw_encoder)*VEL_DELTA_ENC_SCALER;
	velocity = (full_rotations - pre_full_rotations)*VEL_FULL_ROTION_SCALER+delta_encoder;
	pre_raw_encoder = raw_encoder;
    pre_full_rotations = full_rotations;
    return velocity;
}
float EncoderSPI::getAngle(void){
	float offset_angle = (raw_encoder-offset_raw_encoder)/(float)ENCODER_CPR;
    return ((float)full_rotations + offset_angle)*ANGLE_SCALER;
}
